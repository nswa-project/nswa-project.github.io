<!DOCTYPE html><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>NSWA Ranga Web</title><meta name=viewport content="width=device-width,initial-scale=1"><style>body{margin:20px;margin-left:100px;margin-right:100px;font-family:sans-serif;padding-left:340px}body{--code-background:#f9f9f9;--code-font-size:15px;--code-font-family:'Roboto Mono','Ubuntu Mono','Noto Sans Mono',Consolas,Menlo,Monaco,'Lucida Console','DejaVu Sans Mono','Bitstream Vera Sans Mono',monospace}a{color:#08c;text-decoration:none;outline:0}a:hover{color:#005580;text-decoration:none;outline:0}a:active,a:hover{outline:0}a:focus{outline:0}p{word-wrap:break-word}div.sourceCode{display:inline}pre{padding:10px;background-color:var(--code-background);overflow:auto;font-size:var(--code-font-size);font-family:var(--code-font-family)}pre>code{font-size:var(--code-font-size);font-family:var(--code-font-family)}:not(pre)>code{background-color:var(--code-background);padding:4px;font-size:var(--code-font-size);font-family:var(--code-font-family)}blockquote{margin-left:10px;border-left:5px solid #afafaf;padding-left:10px;color:#464646}table{border-width:1px;border-color:#464646;border-collapse:collapse}table th{border-width:1px;padding:8px;border-style:solid;border-color:#464646;background-color:#eaeaea}table td{border-width:1px;padding:8px;border-style:solid;border-color:#464646;background-color:#fff}#FontLoading{display:none;position:fixed;z-index:999;top:50px;right:20px;max-width:300px;background-color:#ffc;padding:10px;box-shadow:0 0 10px 0 #afafaf}#TOC{background-color:var(--code-background);height:100%;width:340px;max-width:340px;position:fixed;overflow:scroll;overflow-x:auto;left:0;top:0}#TOC_MoblieHelper{padding:6px;display:none;position:fixed;left:0;top:0;background:#fff}@media (max-width:980px){body{margin:10px;margin-left:10px;margin-right:10px}}@media (max-width:720px){body{margin:10px;padding-top:30px;padding-left:0;padding-right:0}#TOC{height:unset;width:unset;max-width:unset;position:unset;overflow:unset;display:none}#TOC_MoblieHelper{display:block}}img{margin:20px 0}.box_warn{border:1px solid #d1d5da;background-color:#ffc;padding:8px;margin:8px}a.sourceLine{display:inline-block;line-height:1.25}a.sourceLine{pointer-events:none;color:inherit;text-decoration:inherit}a.sourceLine:empty{height:1.2em}.sourceCode{overflow:visible}code.sourceCode{white-space:pre;position:relative}div.sourceCode{margin:1em 0}pre.sourceCode{margin:0}@media screen{div.sourceCode{overflow:auto}}@media print{code.sourceCode{white-space:pre-wrap}a.sourceLine{text-indent:-1em;padding-left:1em}}pre.numberSource a.sourceLine{position:relative;left:-4em}pre.numberSource a.sourceLine::before{content:attr(title);position:relative;left:-1em;text-align:right;vertical-align:baseline;border:none;pointer-events:all;display:inline-block;-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;padding:0 4px;width:4em;color:#aaa}pre.numberSource{margin-left:3em;border-left:1px solid #aaa;padding-left:4px}@media screen{a.sourceLine::before{text-decoration:underline}}code span.al{color:red;font-weight:700}code span.an{color:#60a0b0;font-weight:700;font-style:italic}code span.at{color:#7d9029}code span.bn{color:#40a070}code span.cf{color:#007020;font-weight:700}code span.ch{color:#4070a0}code span.cn{color:#800}code span.co{color:#60a0b0;font-style:italic}code span.cv{color:#60a0b0;font-weight:700;font-style:italic}code span.do{color:#ba2121;font-style:italic}code span.dt{color:#902000}code span.dv{color:#40a070}code span.er{color:red;font-weight:700}code span.fl{color:#40a070}code span.fu{color:#06287e}code span.in{color:#60a0b0;font-weight:700;font-style:italic}code span.kw{color:#007020;font-weight:700}code span.op{color:#666}code span.ot{color:#007020}code span.pp{color:#bc7a00}code span.sc{color:#4070a0}code span.ss{color:#b68}code span.st{color:#4070a0}code span.va{color:#19177c}code span.vs{color:#4070a0}code span.wa{color:#60a0b0;font-weight:700;font-style:italic}</style><div id=TOC_MoblieHelper><a href=# onclick='document.getElementById("TOC").style.display="block",document.getElementById("TOC_MoblieHelper").style.display="none"'>显示目录</a></div><div id=FontLoading>正在从 Google Fonts 加载字体<br>如果你长时间无法加载字体，则说明你的网络连接或者 DNS 可能有问题</div><div class=box_warn>警告：该文档是从旧文档树中经过简单整理直接发布的，由于当前文档缺乏维护，因此对于当前开源版本主线 NSWA Ranga 可能少部分内容有所过时。如果你发现问题，请前往<a href=https://github.com/nswa-project/website/issues target=_blank>bugtracer</a>提交错误报告。</div><div id=TOC><ul><li><a href=#nswa-ranga-多宿主自定义规则>NSWA Ranga 多宿主自定义规则</a><ul><li><a href=#前提条件重要>前提条件（重要）</a><li><a href=#用法>用法</a><ul><li><a href=#创建和删除规则>创建和删除规则</a><li><a href=#配置规则>配置规则</a><li><a href=#规则的顺序>规则的顺序</a><li><a href=#列出规则列表和信息>列出规则列表和信息</a><li><a href=#重启多宿主服务及查看规则应用状态>重启多宿主服务及查看规则应用状态</a></ul><li><a href=#例子>例子</a><ul><li><a href=#对指定的目的网络只走某一个接口>对指定的目的网络，只走某一个接口</a><li><a href=#对内网的指定主机或网络走制定的接口>对内网的指定主机或网络，走制定的接口</a></ul></ul></ul></div><h1 id=nswa-ranga-多宿主自定义规则>NSWA Ranga 多宿主自定义规则</h1><blockquote><p>请先阅读<a href=intro-cmdline.html>命令行工具手册</a>并了解工具的基本用法。</blockquote><h2 id=前提条件重要>前提条件（重要）</h2><ol start=0 type=1><li><p>使用 4.7.11 或更高版本的系统。<li><p>必须已经启用并基本配置多宿主，参考<a href=euman-mwan.html>多宿主教程</a>。<li><p>只有被加入到“负载均衡列表”的接口才能被自定义规则使用。</ol><h2 id=用法>用法</h2><h3 id=创建和删除规则>创建和删除规则</h3><p>规则名字不可超过 10 个字节，仅允许大小写英文字母和数字。<pre><code>$ ranga-cli config mwan addrule &lt;规则名字&gt;
$ ranga-cli config mwan rmrule &lt;规则名字&gt;</code></pre><h3 id=配置规则>配置规则</h3><pre><code>$ ranga-cli config mwan cfgrule &lt;规则名字&gt; &lt;源地址或源网络CIDR&gt; &lt;源端口号，端口段或 any&gt; &lt;目的地址或目的网络CIDR&gt; &lt;目的端口号，端口段或 any&gt; &lt;接口列表，使用 &#39;,&#39; 分割&gt;</code></pre><p>源地址或源网络CIDR 可以是一个地址（如<code>192.168.1.2</code>）或 CIDR 表示法表示的一个网络中的全部地址，如<code>192.168.1.128/25</code><p>端口号 可以是一个确定的端口号（如<code>443</code>），一组端口号（如<code>2048-4096</code>或<code>80,443</code>），或全部端口（<code>any</code>）<p>例子<pre><code>$ ranga-cli config mwan cfgrule cr0 0.0.0.0/0 any 23.33.0.0/16 443 &#39;mda,mdc&#39;</code></pre><h3 id=规则的顺序>规则的顺序</h3><p>当一个规则被创建时，它会成为最优先的规则。在所有自定义规则的后面，最低优先级的是系统默认规则（全部流量分配全部添加到 “负载均衡列表”的全部接口）。如果需要调整规则的优先级，使用 orderrule 指令。<pre><code>$ ranga-cli config mwan orderrule &lt;规则&gt;,&lt;规则&gt;,...</code></pre><p>越在命令后面的规则将拥有更高的优先级。<blockquote><p>规则匹配是按照优先级顺序的，即从高到低依次匹配，如果某一个规则匹配成功，则按照这个规则的 interfaces 分配负载（interface 中配置的权重和优先级会影响流量百分比分配）。如果没有任何一个自定义规则能匹配到，则会执行默认规则，即 interfaces 为全部加入到“负载均衡列表”的接口</blockquote><h3 id=列出规则列表和信息>列出规则列表和信息</h3><pre><code>$ ranga-cli config mwan lsrule</code></pre><p>规则输出的顺序代表优先级，越早输出（在输出的上面部分）的规则拥有更高的优先级。<h3 id=重启多宿主服务及查看规则应用状态>重启多宿主服务及查看规则应用状态</h3><p>修改自定义规则后不会立即生效，要立即生效，须使用<pre><code>$ ranga-cli action restart mwan</code></pre><p>这个命令会异步地返回。在等待一段时间后，你可以检查多宿主状态，检查自定义规则是否已经应用。<pre><code>$ ranga-cli query network mwan</code></pre><h2 id=例子>例子</h2><h3 id=对指定的目的网络只走某一个接口>对指定的目的网络，只走某一个接口</h3><p>可能某些服务，如游戏加速工具，为了防止帐号共享，限制了源 IP 地址只能为 1 个，这时，可能让所有到游戏加速节点的流量只能从一个接口（本例中为<code>mda</code>）中流出<p>假设该游戏加速服务的地址段为<code>123.45.0.0/16</code><div class=sourceCode id=cb8><pre class="sourceCode bash"><code class="sourceCode bash"><a class=sourceLine id=cb8-1 title=1>$ <span class=ex>ranga-cli</span> config mwan addrule game</a>
<a class=sourceLine id=cb8-2 title=2>$ <span class=ex>ranga-cli</span> config mwan cfgrule game 0.0.0.0/0 any 123.45.0.0/16 any mda</a>
<a class=sourceLine id=cb8-3 title=3>$ <span class=ex>ranga-cli</span> action restart mwan</a></code></pre></div><h3 id=对内网的指定主机或网络走制定的接口>对内网的指定主机或网络，走制定的接口</h3><div class=sourceCode id=cb9><pre class="sourceCode bash"><code class="sourceCode bash"><a class=sourceLine id=cb9-1 title=1>$ <span class=ex>ranga-cli</span> config mwan addrule nas</a>
<a class=sourceLine id=cb9-2 title=2></a>
<a class=sourceLine id=cb9-3 title=3><span class=co># 主机</span></a>
<a class=sourceLine id=cb9-4 title=4>$ <span class=ex>ranga-cli</span> config mwan cfgrule nas 192.168.1.2 any 0.0.0.0/0 any <span class=st>&#39;mda,mdb&#39;</span></a>
<a class=sourceLine id=cb9-5 title=5></a>
<a class=sourceLine id=cb9-6 title=6><span class=co># 网络</span></a>
<a class=sourceLine id=cb9-7 title=7>$ <span class=ex>ranga-cli</span> config mwan cfgrule nas 192.168.1.128/25 any 0.0.0.0/0 any <span class=st>&#39;mda,mdb&#39;</span></a></code></pre></div><blockquote><p>提示：还可以配合 NSWA Ranga 的 DHCP 配置，为指定用户分配指定子网段中的地址</blockquote><script>document.getElementById("FontLoading").style.display="block";var link=document.createElement("link");link.setAttribute("rel","stylesheet"),link.type="text/css",link.href="https://fonts.googleapis.com/css?family=Roboto+Mono",document.head.appendChild(link),link.onload=function(){document.getElementById("FontLoading").style.display="none"},link.onerror=function(){document.getElementById("FontLoading").style.backgroundColor="#ffe2e2",document.getElementById("FontLoading").innerHTML="无法从 Google Fonts 加载字体，你的网络连接或者 DNS 可能有问题"}</script>